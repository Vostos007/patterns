"""
–ü—Ä–∏–º–µ—Ä context-aware chunking —Å overlap –¥–ª—è RAG.

–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
1. –ö–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏ —Å overlap
2. –ü–æ—á–µ–º—É overlap –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è overlap –≤ RAG –ø—Ä–æ–º–ø—Ç–∞—Ö
4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
"""

from kps.knowledge import (
    KnowledgeBase,
    ContextAwareChunker,
    ChunkingStrategy,
    CHUNK_SIZE_PRESETS,
    estimate_optimal_chunk_size,
)


# –ü—Ä–∏–º–µ—Ä –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–±—É–¥–µ—Ç —Ä–∞–∑–±–∏—Ç –Ω–∞ —á–∞–Ω–∫–∏)
LONG_TEXT = """
# –¢–µ—Ö–Ω–∏–∫–∞ –≤—è–∑–∞–Ω–∏—è –∫–æ—Å

–ö–æ—Å—ã - –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É–∑–æ—Ä–æ–≤ –≤ –≤—è–∑–∞–Ω–∏–∏. –û–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –æ–±—ä—ë–º–Ω—É—é —Ç–µ–∫—Å—Ç—É—Ä—É
–∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ —Å–º–æ—Ç—Ä—è—Ç—Å—è –Ω–∞ —Å–≤–∏—Ç–µ—Ä–∞—Ö, —à–∞—Ä—Ñ–∞—Ö –∏ —à–∞–ø–∫–∞—Ö.

## –ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ—Å—ã

–ö–æ—Å—ã (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω - cables) - —ç—Ç–æ —É–∑–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—É—Ç—ë–º –ø–µ—Ä–µ–∫—Ä–µ—â–∏–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø –ø–µ—Ç–µ–ª—å.
–î–ª—è –≤—è–∑–∞–Ω–∏—è –∫–æ—Å –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ø–∏—Ü–∞ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∏–≥–ª–∞ –¥–ª—è –∫–æ—Å.

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫–æ—Å–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–∞–∫: –≥—Ä—É–ø–ø–∞ –ø–µ—Ç–µ–ª—å —Å–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å–ø–∏—Ü—É –∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
–ø–µ—Ä–µ–¥ –∏–ª–∏ –∑–∞ —Ä–∞–±–æ—Ç–æ–π, –∑–∞—Ç–µ–º –≤—è–∂—É—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ç–ª–∏, –∏ –Ω–∞–∫–æ–Ω–µ—Ü –ø—Ä–æ–≤—è–∑—ã–≤–∞—é—Ç—Å—è –ø–µ—Ç–ª–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–ø–∏—Ü—ã.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∏–¥—ã –∫–æ—Å

### –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Å–∞ 2√ó2

–≠—Ç–æ –±–∞–∑–æ–≤–∞—è –∫–æ—Å–∞ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö. –î–ª—è –µ—ë –≤—è–∑–∞–Ω–∏—è:
1. –ü–µ—Ä–µ—Å–Ω–∏–º–∏—Ç–µ 2 –ø–µ—Ç–ª–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å–ø–∏—Ü—É –ø–µ—Ä–µ–¥ —Ä–∞–±–æ—Ç–æ–π
2. –ü—Ä–æ–≤—è–∂–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ 2 –ø–µ—Ç–ª–∏ –ª–∏—Ü–µ–≤—ã–º–∏
3. –ü—Ä–æ–≤—è–∂–∏—Ç–µ 2 –ø–µ—Ç–ª–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–ø–∏—Ü—ã –ª–∏—Ü–µ–≤—ã–º–∏
4. –ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –ø–µ—Ä–µ–∫—Ä–µ—â–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 4-6 —Ä—è–¥–æ–≤

–ü—Ä–æ—Å—Ç–∞—è –∫–æ—Å–∞ 2√ó2 —Ö–æ—Ä–æ—à–æ —Å–º–æ—Ç—Ä–∏—Ç—Å—è –Ω–∞ –∏–∑–¥–µ–ª–∏—è—Ö –∏–∑ —Å—Ä–µ–¥–Ω–µ–π –ø—Ä—è–∂–∏ —Å–ø–∏—Ü–∞–º–∏ 3-4 –º–º.

### –°–ª–æ–∂–Ω–∞—è –∫–æ—Å–∞ 4√ó4

–ë–æ–ª–µ–µ –æ–±—ä—ë–º–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –≤—è–∑–∞–ª—å—â–∏—Ü:
1. –ü–µ—Ä–µ—Å–Ω–∏–º–∏—Ç–µ 4 –ø–µ—Ç–ª–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å–ø–∏—Ü—É
2. –ü—Ä–æ–≤—è–∂–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ 4 –ø–µ—Ç–ª–∏
3. –ü—Ä–æ–≤—è–∂–∏—Ç–µ –ø–µ—Ç–ª–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–ø–∏—Ü—ã
4. –ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –ø–µ—Ä–µ–∫—Ä–µ—â–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 6-8 —Ä—è–¥–æ–≤

### –¢—Ä–æ–π–Ω–∞—è –∫–æ—Å–∞ (–ø–ª–µ—Ç—ë–Ω–∫–∞)

–°–ª–æ–∂–Ω—ã–π —É–∑–æ—Ä –∏–∑ —Ç—Ä—ë—Ö –ø–µ—Ä–µ–ø–ª–µ—Ç–∞—é—â–∏—Ö—Å—è –∫–æ—Å. –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–ø—ã—Ç–∞.

## –ü—Ä—è–∂–∞ –¥–ª—è –∫–æ—Å

–î–ª—è –∫–æ—Å –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç:
- –®–µ—Ä—Å—Ç—å - –¥–µ—Ä–∂–∏—Ç –æ–±—ä—ë–º, —ç–ª–∞—Å—Ç–∏—á–Ω–∞
- –ú–µ—Ä–∏–Ω–æ—Å–æ–≤–∞—è —à–µ—Ä—Å—Ç—å - –º—è–≥–∫–∞—è, –Ω–µ –∫–æ–ª–µ—Ç—Å—è
- –ê–ª—å–ø–∞–∫–∞ - –æ—á–µ–Ω—å —Ç—ë–ø–ª–∞—è, —Ä–æ—Å–∫–æ—à–Ω—ã–π –≤–∏–¥

–ò–∑–±–µ–≥–∞–π—Ç–µ:
- –°–∫–æ–ª—å–∑–∫–∏–µ –ø—Ä—è–∂–∏ (—à—ë–ª–∫, –±–∞–º–±—É–∫) - –∫–æ—Å—ã –Ω–µ –±—É–¥—É—Ç –¥–µ—Ä–∂–∞—Ç—å —Ñ–æ—Ä–º—É
- –°–ª–∏—à–∫–æ–º –ø—É—à–∏—Å—Ç—ã–µ (–º–æ—Ö–µ—Ä) - —É–∑–æ—Ä –Ω–µ –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω

–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ç–æ–ª—â–∏–Ω–∞ –ø—Ä—è–∂–∏ –¥–ª—è –∫–æ—Å: 200-300 –º/100–≥.

## –°–ø–∏—Ü—ã –¥–ª—è –≤—è–∑–∞–Ω–∏—è –∫–æ—Å

–î–ª—è –∫–æ—Å –Ω—É–∂–Ω—ã:
1. –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ø–∏—Ü—ã - –æ–±—ã—á–Ω–æ –ø—Ä—è–º—ã–µ –∏–ª–∏ –∫—Ä—É–≥–æ–≤—ã–µ 3-5 –º–º
2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ø–∏—Ü–∞ –¥–ª—è –∫–æ—Å - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∏–∑–æ–≥–Ω—É—Ç–∞—è –∏–ª–∏ –æ–±—ã—á–Ω–∞—è –∫–æ—Ä–æ—Ç–∫–∞—è —Å–ø–∏—Ü–∞
3. –ú–∞—Ä–∫–µ—Ä—ã –ø–µ—Ç–µ–ª—å - —á—Ç–æ–±—ã –Ω–µ —Å–±–∏—Ç—å—Å—è –≤ —É–∑–æ—Ä–µ

## –ü—Ä–æ–µ–∫—Ç—ã —Å –∫–æ—Å–∞–º–∏

### –®–∞—Ä—Ñ —Å –∫–æ—Å–∞–º–∏

–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö:
- –ü—Ä—è–∂–∞: 200–≥ —à–µ—Ä—Å—Ç–∏ —Å—Ä–µ–¥–Ω–µ–π —Ç–æ–ª—â–∏–Ω—ã
- –°–ø–∏—Ü—ã: 4–º–º –ø—Ä—è–º—ã–µ + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ø–∏—Ü–∞
- –£–∑–æ—Ä: –ø—Ä–æ—Å—Ç–∞—è –∫–æ—Å–∞ 2√ó2
- –†–∞–∑–º–µ—Ä: 20—Å–º √ó 150—Å–º
- –í—Ä–µ–º—è: 15-20 —á–∞—Å–æ–≤

–ù–∞—á–Ω–∏—Ç–µ —Å —Ä–µ–∑–∏–Ω–∫–∏ 2√ó2 –Ω–∞ 5 —Å–º, –∑–∞—Ç–µ–º –≤—è–∂–∏—Ç–µ –∫–æ—Å—ã –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã, –∑–∞–∫–æ–Ω—á–∏—Ç–µ —Ä–µ–∑–∏–Ω–∫–æ–π.

### –®–∞–ø–∫–∞ —Å –∫–æ—Å–∞–º–∏

–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
- –ü—Ä—è–∂–∞: 100–≥ –º–µ—Ä–∏–Ω–æ—Å–∞
- –ö—Ä—É–≥–æ–≤—ã–µ —Å–ø–∏—Ü—ã: 3.5–º–º –∏ 4–º–º
- –£–∑–æ—Ä: –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—ã—Ö –∏ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ—Å
- –†–∞–∑–º–µ—Ä: 52-56—Å–º –æ–±—Ö–≤–∞—Ç
- –í—Ä–µ–º—è: 10-15 —á–∞—Å–æ–≤

### –°–≤–∏—Ç–µ—Ä —Å –∫–æ—Å–∞–º–∏

–î–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –≤—è–∑–∞–ª—å—â–∏—Ü:
- –ü—Ä—è–∂–∞: 600-800–≥ —à–µ—Ä—Å—Ç–∏/–∞–∫—Ä–∏–ª–∞
- –ö—Ä—É–≥–æ–≤—ã–µ —Å–ø–∏—Ü—ã: 4–º–º –∏ 4.5–º–º
- –£–∑–æ—Ä: –ø–∞–Ω–µ–ª—å –∏–∑ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ—Å –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–µ—Ä–µ–¥–∞ –∏ —Å–ø–∏–Ω–∫–∏
- –†–∞–∑–º–µ—Ä—ã: S-XXL
- –í—Ä–µ–º—è: 60-100 —á–∞—Å–æ–≤
"""


def example_1_overlap_importance():
    """–ü—Ä–∏–º–µ—Ä 1: –ü–æ—á–µ–º—É overlap –≤–∞–∂–µ–Ω."""
    print("=" * 70)
    print("–ü–†–ò–ú–ï–† 1: –í–∞–∂–Ω–æ—Å—Ç—å overlap –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏")
    print("=" * 70)

    # –ë–µ–∑ overlap
    print("\n1. –ë–ï–ó OVERLAP (–ø–ª–æ—Ö–æ!):")
    print("-" * 70)

    chunker_no_overlap = ContextAwareChunker(
        chunk_size=500,
        overlap_size=0,  # –ù–ï–¢ OVERLAP
        strategy=ChunkingStrategy.SEMANTIC,
    )

    chunks_no = chunker_no_overlap.chunk(LONG_TEXT, source_id="test")

    for i, chunk in enumerate(chunks_no[:3], 1):
        print(f"\n–ß–∞–Ω–∫ {i}:")
        print(f"  –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:")
        print(f"  ...{chunk.text[-100:]}")
        if i < len(chunks_no):
            print(f"\n  –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞–Ω–∫–∞:")
            print(f"  {chunks_no[i].text[:100]}...")
            print("\n  ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ!")

    # –° overlap
    print("\n\n2. –° OVERLAP (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!):")
    print("-" * 70)

    chunker_with_overlap = ContextAwareChunker(
        chunk_size=500,
        overlap_size=150,  # 30% overlap
        strategy=ChunkingStrategy.SEMANTIC,
    )

    chunks_with = chunker_with_overlap.chunk(LONG_TEXT, source_id="test")

    for i, chunk in enumerate(chunks_with[:3], 1):
        print(f"\n–ß–∞–Ω–∫ {i}:")
        print(f"  –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç (–∫–æ–Ω–µ—Ü): ...{chunk.text[-80:]}")
        if chunk.suffix_context:
            print(f"  Suffix context (overlap): {chunk.suffix_context[:80]}...")
            print(f"  ‚úÖ Overlap: {chunk.metadata.overlap_with_next} —Å–∏–º–≤–æ–ª–æ–≤")


def example_2_rag_with_context():
    """–ü—Ä–∏–º–µ—Ä 2: RAG —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º overlap –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."""
    print("\n\n" + "=" * 70)
    print("–ü–†–ò–ú–ï–† 2: RAG —Å overlap –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º")
    print("=" * 70)

    import tempfile
    from pathlib import Path

    # –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π —Å chunking
    with tempfile.TemporaryDirectory() as tmpdir:
        db_path = Path(tmpdir) / "kb.db"

        # –ë–ï–ó chunking
        print("\n1. –ë–ï–ó CHUNKING:")
        kb_no_chunk = KnowledgeBase(
            str(db_path), use_embeddings=False, use_chunking=False
        )

        # –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        doc_path = Path(tmpdir) / "cables.md"
        doc_path.write_text(LONG_TEXT, encoding="utf-8")

        kb_no_chunk.ingest_folder(str(tmpdir))

        context_no = kb_no_chunk.get_translation_context(
            "–∫–∞–∫ –≤—è–∑–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –∫–æ—Å—É", "ru", "en", limit=1
        )
        print(f"–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {len(context_no)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"–ü—Ä–µ–≤—å—é: {context_no[:200]}...")

        # –° chunking
        print("\n2. –° CHUNKING + OVERLAP:")
        db_path2 = Path(tmpdir) / "kb2.db"
        kb_with_chunk = KnowledgeBase(
            str(db_path2),
            use_embeddings=False,
            use_chunking=True,
            chunk_size=500,
            chunk_overlap=150,
            model_preset=None,
        )

        kb_with_chunk.ingest_folder(str(tmpdir))

        context_with = kb_with_chunk.get_translation_context(
            "–∫–∞–∫ –≤—è–∑–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –∫–æ—Å—É", "ru", "en", limit=1, include_chunk_context=True
        )
        print(f"–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {len(context_with)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"–ü—Ä–µ–≤—å—é: {context_with[:300]}...")
        print("\n‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç overlap –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è!")


def example_3_chunk_size_optimization():
    """–ü—Ä–∏–º–µ—Ä 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–æ–≤."""
    print("\n\n" + "=" * 70)
    print("–ü–†–ò–ú–ï–† 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–µ–π")
    print("=" * 70)

    print("\n–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π:")
    print("-" * 70)

    for model_name, config in CHUNK_SIZE_PRESETS.items():
        print(f"\n{model_name.upper()}:")
        print(f"  –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ: {config['context_window']:,} —Ç–æ–∫–µ–Ω–æ–≤")
        print(f"  –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π chunk_size: {config['recommended_chunk_size']} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"  Overlap: {config['overlap']} —Å–∏–º–≤–æ–ª–æ–≤")

        # –û—Ü–µ–Ω–∫–∞: —Å–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –≤–ª–µ–∑–µ—Ç –≤ –ø—Ä–æ–º–ø—Ç
        tokens_per_char = 0.25  # –ø—Ä–∏–º–µ—Ä–Ω–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
        chunk_tokens = config["recommended_chunk_size"] * tokens_per_char
        num_chunks_fit = int((config["context_window"] - 500) / chunk_tokens)
        print(
            f"  ‚Üí –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ~{num_chunks_fit} —á–∞–Ω–∫–æ–≤ –≤ –æ–¥–Ω–æ–º RAG –ø—Ä–æ–º–ø—Ç–µ"
        )

    # –ö–∞—Å—Ç–æ–º–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
    print("\n\n–ö–ê–°–¢–û–ú–ù–ê–Ø –û–¶–ï–ù–ö–ê:")
    print("-" * 70)

    custom_size = estimate_optimal_chunk_size(
        model_context_window=100000,  # Claude 3
        num_chunks_in_prompt=8,  # –•–æ—Ç–∏–º 8 —á–∞–Ω–∫–æ–≤ –≤ RAG
        prompt_overhead=1000,  # –¢–æ–∫–µ–Ω—ã –Ω–∞ –ø—Ä–æ–º–ø—Ç
        chars_per_token=2.5,  # –†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç
    )

    print(f"–ú–æ–¥–µ–ª—å: Claude 3 (100K tokens)")
    print(f"–ñ–µ–ª–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –≤ RAG: 8")
    print(f"–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π chunk_size: {custom_size} —Å–∏–º–≤–æ–ª–æ–≤")


def example_4_different_strategies():
    """–ü—Ä–∏–º–µ—Ä 4: –†–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ chunking."""
    print("\n\n" + "=" * 70)
    print("–ü–†–ò–ú–ï–† 4: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π chunking")
    print("=" * 70)

    strategies = [
        (ChunkingStrategy.SEMANTIC, "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è (–ø–æ —Å–º—ã—Å–ª—É)"),
        (ChunkingStrategy.FIXED_SIZE, "–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä"),
        (ChunkingStrategy.SLIDING_WINDOW, "–°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ"),
    ]

    for strategy, name in strategies:
        print(f"\n{name.upper()}:")
        print("-" * 70)

        chunker = ContextAwareChunker(
            chunk_size=600, overlap_size=150, strategy=strategy
        )

        chunks = chunker.chunk(LONG_TEXT, source_id="test")

        print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤: {len(chunks)}")
        print(f"–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä: {sum(c.get_size() for c in chunks) // len(chunks)} —Å–∏–º–≤–æ–ª–æ–≤")

        # –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π —á–∞–Ω–∫
        if chunks:
            c = chunks[0]
            print(f"\n–ü–µ—Ä–≤—ã–π —á–∞–Ω–∫:")
            print(f"  –†–∞–∑–º–µ—Ä: {c.get_size()} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"  –° –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º: {c.get_size_with_context()} —Å–∏–º–≤–æ–ª–æ–≤")
            print(f"  –ü—Ä–µ–≤—å—é: {c.text[:100]}...")


def example_5_knowledge_base_with_chunking():
    """–ü—Ä–∏–º–µ—Ä 5: –ü–æ–ª–Ω—ã–π workflow —Å KnowledgeBase."""
    print("\n\n" + "=" * 70)
    print("–ü–†–ò–ú–ï–† 5: KnowledgeBase —Å context-aware chunking")
    print("=" * 70)

    import tempfile
    from pathlib import Path

    with tempfile.TemporaryDirectory() as tmpdir:
        # –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É —Å chunking
        print("\n–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å chunking...")
        kb = KnowledgeBase(
            str(Path(tmpdir) / "kb.db"),
            use_embeddings=False,
            split_sections=True,  # –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ —Å–µ–∫—Ü–∏–∏
            use_chunking=True,  # –ó–∞—Ç–µ–º —Å–µ–∫—Ü–∏–∏ –Ω–∞ —á–∞–Ω–∫–∏
            chunk_size=800,
            chunk_overlap=200,
            model_preset="claude-3",  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Claude
        )

        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
        doc_path = Path(tmpdir) / "cables_guide.md"
        doc_path.write_text(LONG_TEXT, encoding="utf-8")

        count = kb.ingest_folder(str(tmpdir))
        print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {count} —á–∞–Ω–∫–æ–≤")

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats = kb.get_statistics()
        print(f"\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"  –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {stats['total_entries']}")
        print(f"  –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:")
        for cat, cnt in stats["by_category"].items():
            print(f"    {cat:12} : {cnt}")

        # –ü–æ–∏—Å–∫
        print(f"\n–ü–æ–∏—Å–∫: '–ø—Ä–æ—Å—Ç–∞—è –∫–æ—Å–∞'")
        results = kb.search("–ø—Ä–æ—Å—Ç–∞—è –∫–æ—Å–∞", limit=2)

        for r in results:
            print(f"\n  –ù–∞–π–¥–µ–Ω–æ: {r.title}")
            print(f"  –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {r.category.value}")
            print(f"  –†–∞–∑–º–µ—Ä: {len(r.content)} —Å–∏–º–≤–æ–ª–æ–≤")

            # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∞
            if "chunk_id" in r.metadata:
                print(
                    f"  –ß–∞–Ω–∫: {r.metadata['chunk_id']+1}/{r.metadata['total_chunks']}"
                )
                print(
                    f"  Overlap: prev={r.metadata['overlap_prev']}, next={r.metadata['overlap_next']}"
                )

        # RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç
        print(f"\n–ü–æ–ª—É—á–µ–Ω–∏–µ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...")
        context = kb.get_translation_context(
            "–∫–∞–∫ –≤—è–∑–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –∫–æ—Å—É 2√ó2", "ru", "en", limit=2
        )
        print(f"–î–ª–∏–Ω–∞ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {len(context)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"\nRAG –∫–æ–Ω—Ç–µ–∫—Å—Ç:")
        print(context[:400] + "...")


def main():
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã."""
    print("\n" + "üß©" * 35)
    print("CONTEXT-AWARE CHUNKING - –£–º–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ —Å overlap")
    print("üß©" * 35)

    try:
        example_1_overlap_importance()
        example_2_rag_with_context()
        example_3_chunk_size_optimization()
        example_4_different_strategies()
        example_5_knowledge_base_with_chunking()

        print("\n\n" + "=" * 70)
        print("‚úÖ –í–°–ï –ü–†–ò–ú–ï–†–´ –í–´–ü–û–õ–ù–ï–ù–´")
        print("=" * 70)

        print("\nüí° –ö–õ–Æ–ß–ï–í–´–ï –ú–û–ú–ï–ù–¢–´:")
        print()
        print("1. OVERLAP –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ï–ù")
        print("   - –ë–µ–∑ overlap –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö —á–∞–Ω–∫–æ–≤")
        print("   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π overlap: 10-20% –æ—Ç chunk_size")
        print()
        print("2. –†–ê–ó–ú–ï–† –ß–ê–ù–ö–û–í –ó–ê–í–ò–°–ò–¢ –û–¢ –ú–û–î–ï–õ–ò")
        print("   - GPT-3.5: ~800 —Å–∏–º–≤–æ–ª–æ–≤, overlap 150")
        print("   - GPT-4: ~1200 —Å–∏–º–≤–æ–ª–æ–≤, overlap 200")
        print("   - Claude-3: ~3000 —Å–∏–º–≤–æ–ª–æ–≤, overlap 400")
        print()
        print("3. WORKFLOW: Document ‚Üí Sections ‚Üí Chunks")
        print("   - –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏ (–≥–ª–∞–≤—ã)")
        print("   - –ó–∞—Ç–µ–º —Å–µ–∫—Ü–∏–∏ –Ω–∞ —á–∞–Ω–∫–∏ —Å overlap –¥–ª—è RAG")
        print("   - –ö–∞–∂–¥—ã–π —á–∞–Ω–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (prefix/suffix)")
        print()
        print("4. RAG –ò–°–ü–û–õ–¨–ó–£–ï–¢ OVERLAP –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò")
        print("   - get_translation_context() –≤–∫–ª—é—á–∞–µ—Ç overlap –∫–æ–Ω—Ç–µ–∫—Å—Ç")
        print("   - –ú–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É, –Ω–µ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã")
        print()
        print("–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:")
        print("  kb = KnowledgeBase(")
        print("      'data/kb.db',")
        print("      use_chunking=True,      # –í–∫–ª—é—á–∏—Ç—å chunking")
        print("      chunk_size=1000,        # –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞")
        print("      chunk_overlap=200,      # Overlap 20%")
        print("      model_preset='claude-3' # –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞")
        print("  )")

    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback

        traceback.print_exc()


if __name__ == "__main__":
    main()
